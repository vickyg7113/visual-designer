<!DOCTYPE html>
<!--
  Target Simulator – replicates your target URL flow (snippet + init after login).
  How to test:
  1. Run: npm run build:sdk   (so cdn/ has visual-designer.umd.cjs)
  2. Run: npm run dev
  3. Open launcher: http://localhost:3000/launcher.html
  4. Click "Use Target Simulator (snippet + login)", then "Launch Designer" (Guide) or "Launch Tag Feature"
  5. You get this page with ?designer=true&mode=... → localStorage is set, login screen shows
  6. Sign in → initializeVisualDesigner runs → VisualDesigner.init() → designer should appear
-->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Target Simulator (Snippet + Login → Init)</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .login-screen {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    }
    .login-card {
      background: white;
      padding: 32px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.1);
      width: 100%;
      max-width: 400px;
    }
    .login-card h1 { margin-bottom: 8px; font-size: 24px; color: #0f172a; }
    .login-card p { color: #64748b; margin-bottom: 24px; font-size: 14px; }
    .login-card .form-group { margin-bottom: 16px; }
    .login-card label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; }
    .login-card input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      font-size: 14px;
    }
    .login-card button {
      width: 100%;
      padding: 12px;
      background: #3b82f6;
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }
    .login-card button:hover { background: #2563eb; }
    .app-screen { display: none; min-height: 100vh; }
    .app-screen.visible { display: block; }
    .target-nav {
      background: white;
      padding: 16px 24px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
    }
    .target-nav-links {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .target-nav-links a {
      padding: 8px 14px;
      border-radius: 6px;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      color: #64748b;
      transition: background 0.2s, color 0.2s;
    }
    .target-nav-links a:hover { color: #0f172a; background: #f1f5f9; }
    .target-nav-links a.active { color: #3b82f6; background: #eff6ff; }
    .target-nav .user { font-size: 14px; color: #64748b; }
    .target-nav .logout {
      padding: 8px 16px;
      background: #f1f5f9;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
    }
    .target-content { padding: 24px; max-width: 800px; margin: 0 auto; }
    .target-content h2 { margin-bottom: 16px; }
    .target-content p { color: #64748b; margin-bottom: 24px; }
    .target-page { display: none; }
    .target-page.active { display: block; }
    .target-content .card { background: #fff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 16px; }
    .target-content .card h3 { margin-bottom: 12px; font-size: 16px; color: #0f172a; }
    .target-content .card-content p { margin: 0; color: #475569; font-size: 14px; }
    .target-content .stat-row { display: flex; gap: 24px; margin-top: 12px; }
    .target-content .stat { padding: 12px 16px; background: #f8fafc; border-radius: 8px; min-width: 100px; }
    .target-content .stat-value { font-size: 20px; font-weight: 600; color: #0f172a; }
    .target-content .stat-label { font-size: 12px; color: #64748b; margin-top: 4px; }
    .debug-box {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 16px;
      margin-top: 24px;
      font-family: monospace;
      font-size: 12px;
      color: #475569;
    }
    .debug-box strong { color: #0f172a; }
  </style>
</head>
<body>
  <!-- Login screen (shown when not "logged in") -->
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <h1>Sign in</h1>
      <p>Target simulator – same flow as your app (snippet + init after login)</p>
      <form id="loginForm">
        <div class="form-group">
          <label for="email">Email</label>
          <input type="email" id="email" name="email" value="user@example.com" required />
        </div>
        <div class="form-group">
          <label for="password">Password</label>
          <input type="password" id="password" name="password" value="password123" required />
        </div>
        <button type="submit">Sign in</button>
      </form>
    </div>
  </div>

  <!-- App screen (shown after "login") -->
  <div id="appScreen" class="app-screen">
    <nav class="target-nav">
      <div class="target-nav-links">
        <a href="#/dashboard" data-page="dashboard" class="nav-page">Dashboard</a>
        <a href="#/support" data-page="support" class="nav-page">Support</a>
        <a href="#/settings" data-page="settings" class="nav-page">Settings</a>
        <a href="#/profile" data-page="profile" class="nav-page">Profile</a>
      </div>
      <div>
        <span class="user" id="userEmail">user@example.com</span>
        <button type="button" class="logout" id="logoutBtn">Log out</button>
      </div>
    </nav>
    <main class="target-content">
      <!-- Dashboard Page -->
      <div id="page-dashboard" class="target-page active" data-page="dashboard">
        <h2>Dashboard</h2>
        <p>Overview of your app. Use Tag Page designer to tag this page (e.g. as "Dashboard").</p>
        <div class="card">
          <h3>Quick stats</h3>
          <div class="card-content">
            <div class="stat-row">
              <div class="stat"><div class="stat-value">1,234</div><div class="stat-label">Users</div></div>
              <div class="stat"><div class="stat-value">56</div><div class="stat-label">Projects</div></div>
              <div class="stat"><div class="stat-value">12</div><div class="stat-label">Active</div></div>
            </div>
          </div>
        </div>
        <div class="card">
          <h3>Recent activity</h3>
          <div class="card-content">
            <p>Sample dashboard content for tagging pages testing.</p>
          </div>
        </div>
      </div>
      <!-- Support Page -->
      <div id="page-support" class="target-page" data-page="support">
        <h2>Support</h2>
        <p>Support and tickets. Tag this page (e.g. as "Support" or "Tickets").</p>
        <div class="card">
          <h3>Tickets</h3>
          <div class="card-content">
            <p>If you launched from the launcher with Guide or Tag Feature, the designer appears after sign in. Navigate between Dashboard, Support, Settings, Profile to test tagging different pages.</p>
          </div>
        </div>
      </div>
      <!-- Settings Page -->
      <div id="page-settings" class="target-page" data-page="settings">
        <h2>Settings</h2>
        <p>Application settings. Tag this page for testing (e.g. "Settings").</p>
        <div class="card">
          <h3>Account</h3>
          <div class="card-content">
            <p>Theme, notifications, language preferences.</p>
          </div>
        </div>
        <div class="card">
          <h3>Privacy</h3>
          <div class="card-content">
            <p>Privacy and security options.</p>
          </div>
        </div>
      </div>
      <!-- Profile Page -->
      <div id="page-profile" class="target-page" data-page="profile">
        <h2>Profile</h2>
        <p>User profile. Tag this page (e.g. "Profile") for tagging pages testing.</p>
        <div class="card">
          <h3>Personal info</h3>
          <div class="card-content">
            <p>Name, email, avatar and profile details.</p>
          </div>
        </div>
        <div class="card">
          <h3>Preferences</h3>
          <div class="card-content">
            <p>Profile visibility and notification preferences.</p>
          </div>
        </div>
      </div>
      <div class="debug-box" id="debugBox">
        <strong>Debug</strong><br>
        Current page (hash): <span id="debugPage">-</span><br>
        localStorage.designerMode: <span id="debugDesignerMode">-</span><br>
        localStorage.designerModeType: <span id="debugDesignerModeType">-</span><br>
        VisualDesigner loaded: <span id="debugVD">-</span><br>
        getInstance(): <span id="debugInstance">-</span>
      </div>
    </main>
  </div>

  <!-- Same snippet as your target URL – creates stub, then loads UMD -->
  <script>
    (function (cdnUrl) {
      (function (r, e, v, a, i) {
        var w, x, y, z, t;
        a = r[i] = r[i] || {};
        a._q = a._q || [];
        w = ["initialize", "identify", "enableEditor", "disableEditor", "loadGuides", "getGuides"];
        for (x = 0, y = w.length; x < y; ++x) {
          (function (m) {
            a[m] = a[m] || function () {
              a._q[m === w[0] ? "unshift" : "push"]([m].concat([].slice.call(arguments, 0)));
            };
          })(w[x]);
        }
        z = e.createElement(v);
        z.async = !0;
        z.src = cdnUrl;
        z.onload = function() {
          setTimeout(function() {
            if (r.VisualDesigner && r.VisualDesigner._processQueue) {
              r.VisualDesigner._processQueue(a._q);
            }
          }, 100);
        };
        t = e.getElementsByTagName(v)[0];
        t.parentNode.insertBefore(z, t);
      })(window, document, "script", null, "visualDesigner");
    })("/visual-designer/v1/visual-designer.umd.cjs");
  </script>

  <script>
    (function() {
      var loginScreen = document.getElementById('loginScreen');
      var appScreen = document.getElementById('appScreen');
      var loginForm = document.getElementById('loginForm');
      var logoutBtn = document.getElementById('logoutBtn');
      var userEmailEl = document.getElementById('userEmail');
      var debugPage = document.getElementById('debugPage');
      var debugDesignerMode = document.getElementById('debugDesignerMode');
      var debugDesignerModeType = document.getElementById('debugDesignerModeType');
      var debugVD = document.getElementById('debugVD');
      var debugInstance = document.getElementById('debugInstance');

      var isAuthenticated = false;
      var currentUser = null;
      var VALID_PAGES = ['dashboard', 'support', 'settings', 'profile'];

      function getPageFromHash() {
        var hash = (window.location.hash || '#/dashboard').slice(1);
        var path = hash.slice(0, 1) === '/' ? hash.slice(1) : hash;
        var page = path.split('/')[0] || 'dashboard';
        return VALID_PAGES.indexOf(page) >= 0 ? page : 'dashboard';
      }

      function showPage(pageId) {
        document.querySelectorAll('.target-page').forEach(function(el) {
          el.classList.toggle('active', el.getAttribute('data-page') === pageId);
        });
        document.querySelectorAll('.nav-page').forEach(function(a) {
          a.classList.toggle('active', a.getAttribute('data-page') === pageId);
        });
        if (debugPage) debugPage.textContent = pageId;
      }

      function syncHashToPage() {
        var page = getPageFromHash();
        showPage(page);
      }

      function updateDebug() {
        if (debugDesignerMode) debugDesignerMode.textContent = localStorage.getItem('designerMode') || '(empty)';
        if (debugDesignerModeType) debugDesignerModeType.textContent = localStorage.getItem('designerModeType') || '(empty)';
        if (debugVD) debugVD.textContent = window.VisualDesigner ? 'yes' : 'no';
        if (debugInstance) debugInstance.textContent = window.VisualDesigner && window.VisualDesigner.getInstance ? (window.VisualDesigner.getInstance() ? 'instance' : 'null') : 'N/A';
      }

      function showScreen(loggedIn) {
        loginScreen.style.display = loggedIn ? 'none' : 'flex';
        appScreen.classList.toggle('visible', loggedIn);
        if (loggedIn) {
          userEmailEl.textContent = currentUser && currentUser.email ? currentUser.email : 'user@example.com';
          syncHashToPage();
        }
        updateDebug();
      }

      // Same as AuthConfig: initialize Visual Designer only after login (read from window at call time)
      function initializeVisualDesigner(userData) {
        try {
          var VD = window.VisualDesigner;
          if (!VD || typeof VD.init !== 'function') {
            console.warn('[Target Simulator] Visual Designer SDK not loaded yet.');
            return;
          }
          console.log('[Target Simulator] Initializing Visual Designer with user data');
          var config = userData && typeof userData === 'object' ? userData : {};
          VD.init(config);
          console.log('[Target Simulator] Visual Designer initialized');
        } catch (e) {
          console.error('[Target Simulator] Visual Designer init error:', e);
        }
      }

      loginForm.addEventListener('submit', function(e) {
        e.preventDefault();
        var email = document.getElementById('email').value;
        var password = document.getElementById('password').value;
        currentUser = {
          sub: 'user-123',
          id: 'user-123',
          email: email,
          given_name: 'Demo',
          family_name: 'User',
          organizationId: 'org-1',
          organizationName: 'Demo Org'
        };
        isAuthenticated = true;
        showScreen(true);

        // Same as your AuthConfig: init after login (at call time, so we get real SDK)
        initializeVisualDesigner(currentUser);
        updateDebug();
      });

      logoutBtn.addEventListener('click', function() {
        isAuthenticated = false;
        currentUser = null;
        showScreen(false);
        updateDebug();
      });

      // Hash-based routing for multiple pages (tagging pages testing)
      window.addEventListener('hashchange', syncHashToPage);
      if (!window.location.hash || window.location.hash === '#') {
        window.location.hash = '#/dashboard';
      }
      syncHashToPage();

      // Initial state
      showScreen(false);
      setInterval(updateDebug, 2000);
    })();
  </script>
</body>
</html>
